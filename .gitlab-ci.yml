stages:
  - build
  - test
  - release
  - deploy

variables:
  IMAGES_NAME: 'gitlab-project'
  IMAGES_TAG: 'v1'
  DOCKER_USERNAME: 'lamsking'
  #DOCKER_PASSWORD:
  HOST_PORT: 80
  CONTAINER_PORT: 80
  SERVER_USERNAME: 'ubuntu'

# Build de l'image
Build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  script:
    - docker build --no-cache -t $IMAGES_NAME:$IMAGES_TAG .
    - docker save -o gitlab-project.tar $IMAGES_NAME:IMAGES_TAG
  artifacts:
    paths:
      - gitlab-project.tar

  .test_templates: &test_templates
    stage: test
    before_script:
      - apk add --no-cache curl
    script:
      - docker load -i gitlab-project.tar
      - dockr run --rm -dp $HOST_PORT:$CONTAINER_PORT --name $IMAGES_NAME $IMAGES_NAME:$IMAGES_TAG
      - sleep 5
      - curl -I "http://docker" | grep  -i 200

  Test:
    stage: test
    image: docker:latest
    services:
      - name: docker:dind
        alias: docker
    <<: *test_templates

.release_image: &release_image
  stage: release
  script:
    # use when variable define by gitlab
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
    # use when variable define by code script
    #- docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker load -i gitlab-project.tar
    - docker tag $IMAGES_NAME:$IMAGES_TAG $DOCKER_USERNAME/$IMAGES_NAME:$IMAGES_TAG
    - docker push $DOCKER_USERNAME//$IMAGES_NAME:$IMAGES_TAG

Release Image:
  stage: release
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  <<: *release_image

.deploy_app: &deploy_app
  stage: deploy
  before_script:
    - apk add --no-cache openssh
    - eval $(ssh-agent -s)
    - echo "SSH_PRIVATE_KEY | base64 -d > /tmp*id_rsa"
    - chmod 600 /tmp/id_rsa
    - ssh-add /tmp/id_rsa
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStricHostKeyCheking no\n\n" > ~/.ssh/config
  script:
    - ssh -o StricHostKeyChecking=no -i /tmp/id_rsa $SERVER_USERNAME@SERVER_IP "docker pull $DOCKER_USERNAME/$IMAGES_NAME:$IMAGES_TAG "
    - ssh -o StricHostKeyChecking=no -i /tmp/id_rsa $SERVER_USERNAME@SERVER_IP "docker run --rm -dp $HOST_PORT:$CONTAINER_PORT --name $IMAGES_NAME $IMAGES_NAME:$IMAGES_TAG"

Deploy Review:
  stage: deploy
  variables:
    SERVER_IP: ''
  image: alpine
  <<: *deploy_app
  environment:
    name: Review

Deploy Staging:
  stage: deploy
  variables:
    SERVER_IP: ''
  image: alpine
  <<: *deploy_app
  environemen:
    name: Staging

Deploy Production:
  stage: deploy
  variables:
    SERVER_IP: ''
  image: alpine
  <<: *deploy_app
  environemen:
    name: Production